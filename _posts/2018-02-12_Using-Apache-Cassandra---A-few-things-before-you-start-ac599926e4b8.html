<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Using Apache Cassandra — A few things before you start</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Using Apache Cassandra — A few things before you start</h1>
</header>
<section data-field="subtitle" class="p-summary">
The CQL — Cassandra Query language gives an almost SQL type interface to Apache Cassandra. I have found many times, that many who use this…
</section>
<section data-field="body" class="e-content">
<section name="f7da" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="203a" id="203a" class="graf graf--h3 graf--leading graf--title">Using Apache Cassandra — A few things before you start</h3><p name="8aee" id="8aee" class="graf graf--p graf-after--h3">The <a href="https://www.slideshare.net/planetcassandra/cassandra-summit-2014-cql-under-the-hood-39445761" data-href="https://www.slideshare.net/planetcassandra/cassandra-summit-2014-cql-under-the-hood-39445761" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">CQL</a> — Cassandra Query language gives an almost SQL type interface to Apache Cassandra. I have found many times, that many who use this, do not know about some important points of Cassandra that makes it different from SQL databases like Postgres. Same is the case for the operations team, there are some aspects related to storage, GC settings, that many are not aware of. I am not an expert in Cassandra internals and don’t aspire to be if I can avoid it. This is mostly a note to myself, and something which I can ask others to refer to instead of repeating over email a gazillion times. There are a lot of other parts like repair etc which I have left out. The intention here is to make this as short as possible, but if you feel somethings are to be added, please comment.</p><h4 name="2e37" id="2e37" class="graf graf--h4 graf-after--p">Cassandra has Tune-able Consistency — not just eventual consistency</h4><p name="0963" id="0963" class="graf graf--p graf-after--h4">Many considering Cassandra as a replacement for SQL databases like Postgres, MySQL or Oracle, shy away from thinking that eventual consistency of NoSQL does not meet their requirement. In Cassandra, however, consistency is configurable. This means that with some write and read speed sacrifice, you can have strong consistency as well as high availability. Cassandra can be used for small data as well as big data; depending on your use case you can tune the consistency per key-space or even per-operation.</p><blockquote name="86c1" id="86c1" class="graf graf--blockquote graf-after--p">Cassandra values Availability and Partitioning tolerance (AP). Tradeoffs between consistency and latency are tunable in Cassandra. You can get strong consistency with Cassandra (with an increased latency).<br><a href="https://wiki.apache.org/cassandra/ArchitectureOverview" data-href="https://wiki.apache.org/cassandra/ArchitectureOverview" class="markup--anchor markup--blockquote-anchor" rel="nofollow noopener noopener" target="_blank">https://wiki.apache.org/cassandra/ArchitectureOverview</a></blockquote><p name="712d" id="712d" class="graf graf--p graf-after--blockquote">At this point, it may be a good idea to have a short recap of <strong class="markup--strong markup--p-strong">CAP theorem </strong>as there is a lot of confusion translating the theoretical surmise to the practical world.</p><blockquote name="e767" id="e767" class="graf graf--blockquote graf-after--p">In 2000, Dr. Eric Brewer gave a keynote at the <em class="markup--em markup--blockquote-em">Proceedings of the Annual ACM Symposium on Principles of Distributed Computing</em> in which he laid out his famous CAP Theorem: <em class="markup--em markup--blockquote-em">a shared-data system can have at most two of the three following properties: </em><strong class="markup--strong markup--blockquote-strong"><em class="markup--em markup--blockquote-em">C</em></strong><em class="markup--em markup--blockquote-em">onsistency, </em><strong class="markup--strong markup--blockquote-strong"><em class="markup--em markup--blockquote-em">A</em></strong><em class="markup--em markup--blockquote-em">vailability, and tolerance to network </em><strong class="markup--strong markup--blockquote-strong"><em class="markup--em markup--blockquote-em">P</em></strong><em class="markup--em markup--blockquote-em">artitions.</em></blockquote><p name="cb8b" id="cb8b" class="graf graf--p graf-after--blockquote">This applies to any distributed database, not just Cassandra. So Cassandra can provide C and A not P ? Is it a big problem?</p><p name="c5f4" id="c5f4" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Short answer — It is not. Skip the rest of the section if you are in a hurry.</strong></p><p name="b375" id="b375" class="graf graf--p graf-after--p">Long answer read on. Here is the excerpt from Cassandra docs. (DataStax’s docs)</p><blockquote name="82aa" id="82aa" class="graf graf--blockquote graf-after--p">… You can tune Cassandra’s consistency level per-operation, or set it globally for a cluster or datacenter. You can vary the consistency for individual read or write operations so that the data returned is more or less consistent, as required by the client application. This allows you to make Cassandra act more like a CP (consistent and partition tolerant) or AP (highly available and partition tolerant) system according to the CAP theorem, depending on the application requirements.</blockquote><blockquote name="8be4" id="8be4" class="graf graf--blockquote graf-after--blockquote"><strong class="markup--strong markup--blockquote-strong">Note:</strong> It is not possible to “tune” Cassandra into a completely CA system. See <a href="https://codahale.com/you-cant-sacrifice-partition-tolerance/" data-href="https://codahale.com/you-cant-sacrifice-partition-tolerance/" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank">You Can’t Sacrifice Partition Tolerance</a> for a more detailed discussion. -<a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlAboutDataConsistency.html#dmlAboutDataConsistency__eventual-consistency" data-href="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlAboutDataConsistency.html#dmlAboutDataConsistency__eventual-consistency" class="markup--anchor markup--blockquote-anchor" rel="nofollow noopener" target="_blank">https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlAboutDataConsistency.html</a></blockquote><p name="f1c2" id="f1c2" class="graf graf--p graf-after--blockquote">Here is an excerpt from the article linked in the DataStax’ s Cassandra documentation page.</p><blockquote name="15b8" id="15b8" class="graf graf--blockquote graf-after--p">Of the CAP theorem’s Consistency, Availability, and Partition Tolerance, <strong class="markup--strong markup--blockquote-strong">Partition Tolerance is mandatory in distributed systems. You cannot not choose it. </strong>Instead of CAP, you should think about your availability in terms of <em class="markup--em markup--blockquote-em">yield</em> (percent of requests answered successfully) and <em class="markup--em markup--blockquote-em">harvest</em> (percent of required data actually included in the responses) and which of these two your system will sacrifice when failures happen. -<a href="https://codahale.com/you-cant-sacrifice-partition-tolerance/" data-href="https://codahale.com/you-cant-sacrifice-partition-tolerance/" class="markup--anchor markup--blockquote-anchor" rel="nofollow noopener" target="_blank">https://codahale.com/you-cant-sacrifice-partition-tolerance/</a></blockquote><p name="c333" id="c333" class="graf graf--p graf-after--blockquote">What the above article explains in depth is that Availability is tied to Network Partitioning or Partition Tolerance. Worst case scenario network partitions are quite rare inside a Data Center network. Also, network partitions cannot be prevented from happening. It is ever present, though mostly transient and intermittent. The risk of network partitioning across many nodes in a cluster so as to disrupt Availability for a multi-node cluster is very less.</p><p name="ddd6" id="ddd6" class="graf graf--p graf-after--p">So with Cassandra, you can have as good a C and A system as practically possible (you cannot choose Partition tolerance, shit happens in networks)</p><blockquote name="6614" id="6614" class="graf graf--blockquote graf-after--p">The correct way to think about CAP is that in case of a network partition (a rare occurrence) one needs to choose between availability and partition tolerance. In any networked shared-data systems partition tolerance is a must. Network partitions and dropped messages are a fact of life and must be handled appropriatel — Please read <a href="https://dzone.com/articles/understanding-the-cap-theorem" data-href="https://dzone.com/articles/understanding-the-cap-theorem" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank">this</a> article to get a better perspective of CAP</blockquote><figure name="1810" id="1810" class="graf graf--figure graf-after--blockquote"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 821px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 117.30000000000001%;"></div><img class="graf-image" data-image-id="0*TyFAHQt2cqkKo_yj.png" data-width="728" data-height="854" src="https://cdn-images-1.medium.com/max/800/0*TyFAHQt2cqkKo_yj.png"></div><figcaption class="imageCaption">Source the intuition behind CAP <a href="https://dzone.com/articles/understanding-the-cap-theorem" data-href="https://dzone.com/articles/understanding-the-cap-theorem" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">https://dzone.com/articles/understanding-the-cap-theorem</a></figcaption></figure><h4 name="f386" id="f386" class="graf graf--h4 graf-after--figure"><strong class="markup--strong markup--h4-strong">Give Importance to modeling the Partition key</strong></h4><p name="607e" id="607e" class="graf graf--p graf-after--h4">If there is only one thing that you should read, maybe it is the link below</p><div name="bbe9" id="bbe9" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://www.datastax.com/dev/blog/the-most-important-thing-to-know-in-cassandra-data-modeling-the-primary-key" data-href="https://www.datastax.com/dev/blog/the-most-important-thing-to-know-in-cassandra-data-modeling-the-primary-key" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://www.datastax.com/dev/blog/the-most-important-thing-to-know-in-cassandra-data-modeling-the-primary-key"><strong class="markup--strong markup--mixtapeEmbed-strong">The most important thing to know in Cassandra data modeling: The primary key</strong><br><em class="markup--em markup--mixtapeEmbed-em">Patrick is regarded as one of the foremost experts of Apache Cassandra and data modeling techniques. As the Chief…</em>www.datastax.com</a><a href="https://www.datastax.com/dev/blog/the-most-important-thing-to-know-in-cassandra-data-modeling-the-primary-key" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="68a3264509d01e9f7bcb5f3f842ac79c" data-thumbnail-img-id="0*RVC4ux0FtVmWja8W." style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*RVC4ux0FtVmWja8W.);"></a></div><p name="958c" id="958c" class="graf graf--p graf-after--mixtapeEmbed">What is the Partition Key ? It is the first part of the Primary Key or the Primary key itself if the Primary key is not composite</p><p name="5327" id="5327" class="graf graf--p graf-after--p">Why is this most important part?</p><p name="fbfc" id="fbfc" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">To have a balanced write of data to multiple Cassandra nodes in the cluster and subsequently balanced reads of the data.</strong></p><blockquote name="fe60" id="fe60" class="graf graf--blockquote graf-after--p">When data is inserted into the cluster, the first step is to apply a hash function to the partition key. The output is used to determine what node (and replicas) will get the data.-<a href="https://docs.datastax.com/en/archived/cassandra/3.x/cassandra/architecture/archPartitionerM3P.html" data-href="https://docs.datastax.com/en/archived/cassandra/3.x/cassandra/architecture/archPartitionerM3P.html" class="markup--anchor markup--blockquote-anchor" rel="nofollow noopener" target="_blank">https://docs.datastax.com/en/archived/cassandra/3.x/cassandra/architecture/archPartitionerM3P.html</a></blockquote><h4 name="1e3d" id="1e3d" class="graf graf--h4 graf-after--blockquote">Here are two main goals to consider for modelling the data</h4><div name="7db1" id="7db1" class="graf graf--mixtapeEmbed graf-after--h4"><a href="https://www.datastax.com/dev/blog/basic-rules-of-cassandra-data-modeling" data-href="https://www.datastax.com/dev/blog/basic-rules-of-cassandra-data-modeling" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://www.datastax.com/dev/blog/basic-rules-of-cassandra-data-modeling"><strong class="markup--strong markup--mixtapeEmbed-strong">Basic Rules of Cassandra Data Modeling</strong><br><em class="markup--em markup--mixtapeEmbed-em">Learn more about Apache Cassandra and data modeling READ MORE DS:220 COURSE Picking the right data model is the hardest…</em>www.datastax.com</a><a href="https://www.datastax.com/dev/blog/basic-rules-of-cassandra-data-modeling" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="4878a799e69554418aba8ee8b34e21a3" data-thumbnail-img-id="0*iQdukK2UHu2XWWHW." style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*iQdukK2UHu2XWWHW.);"></a></div><p name="1dab" id="1dab" class="graf graf--p graf-after--mixtapeEmbed"><strong class="markup--strong markup--p-strong">1. Spread data evenly around the cluster — Model Partition Key</strong></p><p name="8ae6" id="8ae6" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">2. Minimize the number of partitions read -Model Partition Key and Clustering keys</strong></p><p name="58e7" id="58e7" class="graf graf--p graf-after--p">I have written here the <a href="https://medium.com/techlogs/apache-cassandra-the-minimum-internals-you-need-to-know-89724603abb2" data-href="https://medium.com/techlogs/apache-cassandra-the-minimum-internals-you-need-to-know-89724603abb2" class="markup--anchor markup--p-anchor" target="_blank">minimum internals of Cassandra</a> which gives us this sort of <strong class="markup--strong markup--p-strong">two conflicting guidelines, which we need to balance to use it effectively</strong>.</p><h4 name="666b" id="666b" class="graf graf--h4 graf-after--p">An Example</h4><p name="9ea6" id="9ea6" class="graf graf--p graf-after--h4">Let us take an example. Below is an initial modeling of the table where the <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">data is some events (say political rallies, speeches etc) that has occurred in a particular location, centered over latitude, longitude and say having a radius of 250 meters. Each location has an influential candidate of that area. Sometimes the same area can have multiple influential candidates.</em></strong> I have illustrated a slightly complex example so as to show the flexibility in data types present in Cassandra, and all the aspects to consider when modeling the key. The actual cell can be a telecom cell with multiple coverages by different operators or different technologies. The example I give here is a bit contrived and for illustration only.</p><figure name="716e" id="716e" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/alexcpn/66559ac186a6ee3d951b51a08ef9be0b#file-datamodel-csv.js"></script></figure><p name="8775" id="8775" class="graf graf--p graf-after--figure">Note that the partition key is chosen assuming that events are distributed evenly across a city, <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">the key will distribute the data from multiple locations evenly across available Cassandra nodes.</em></strong></p><p name="9ffa" id="9ffa" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">The partition query should be modelled for efficient retrieval of the data application needs</strong></p><p name="9633" id="9633" class="graf graf--p graf-after--p">The modelling of Tables and thereby the partition key is primarily with consideration of efficient data retrieval.</p><p name="02b8" id="02b8" class="graf graf--p graf-after--p">Assume that we need to <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">query all events happening in a location by a Candidate for a time interval.</em></strong> The queries will be a set of statements like</p><blockquote name="ec1c" id="ec1c" class="graf graf--blockquote graf-after--p"><strong class="markup--strong markup--blockquote-strong">select * from demo_table where bin_cell_key = (1234, 222, ‘Candidate1’)</strong> and time_key &gt;= (‘06:00:00.000000000’, ‘06:00:00.000000000’) and time_key &lt; (‘07:30:00.000000000’, ‘07:30:00.000000000’)</blockquote><blockquote name="6b6b" id="6b6b" class="graf graf--blockquote graf-after--blockquote">select * from demo_table where bin_cell_key = (1234, 223, ‘Candidate1’) ..</blockquote><p name="feeb" id="feeb" class="graf graf--p graf-after--blockquote"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">But to compose this bin_cell_key we need to know first which Candidates are there in which locations</em></strong>. For this, we need to model<strong class="markup--strong markup--p-strong"> helper tables</strong>. Note — Data duplication is okay in NoSQL data modelling and to have the same effect of JOINs this is needed. Some helper tables to get the bin_cell_key</p><blockquote name="42fa" id="42fa" class="graf graf--blockquote graf-after--p">create table cell_bin (cell text, bin tuple&lt;int,int&gt;, PRIMARY KEY (cell,bin));</blockquote><p name="ac52" id="ac52" class="graf graf--p graf-after--blockquote">Example CQL:</p><blockquote name="011b" id="011b" class="graf graf--blockquote graf-after--p"><strong class="markup--strong markup--blockquote-strong">select * from cell_bin where cell=’Candidate1’;</strong></blockquote><blockquote name="f71c" id="f71c" class="graf graf--blockquote graf-after--blockquote">cell | bin<br> — — — — -+ — — — — —-<br>Candidate1| <strong class="markup--strong markup--blockquote-strong">(1234, 222)</strong><br>Candidate1| (<strong class="markup--strong markup--blockquote-strong">1234, 223)</strong></blockquote><p name="f849" id="f849" class="graf graf--p graf-after--blockquote">And similarly for the other way round</p><blockquote name="caf0" id="caf0" class="graf graf--blockquote graf-after--p">create table bin_cell (bin tuple&lt;int,int&gt;, cell text, PRIMARY KEY (bin,cell));</blockquote><p name="21a2" id="21a2" class="graf graf--p graf-after--blockquote">Example CQL:</p><blockquote name="0774" id="0774" class="graf graf--blockquote graf-after--p">cqlsh:demo_keyspace&gt; <strong class="markup--strong markup--blockquote-strong">select * from bin_cell where bin = (1234, 222);</strong><br> bin | cell<br> — — — — -+ — — — —— -<br> (1234, 222) | <strong class="markup--strong markup--blockquote-strong">Candidate1</strong><br> (1234, 222) | <strong class="markup--strong markup--blockquote-strong">Candidate2</strong></blockquote><p name="fca6" id="fca6" class="graf graf--p graf-after--blockquote">We can stop here. But if you are curious -read on. <strong class="markup--strong markup--p-strong">What if we want to aggregate all events that have taken place in a region irrespective of the Candidate. </strong>For this, we need to <strong class="markup--strong markup--p-strong">split the cell out.</strong> Why ? because in case of a composite partition key all the elements need to be specified in the query.</p><blockquote name="ebf9" id="ebf9" class="graf graf--blockquote graf-after--p"><strong class="markup--strong markup--blockquote-strong">select * from demo_table where bin = (1234,222) and year=2017 and month=12 and day=1;</strong></blockquote><p name="81aa" id="81aa" class="graf graf--p graf-after--blockquote">The table for below which also adds time to the partition key so that data from different days are distributed across available nodes are given below.</p><figure name="2100" id="2100" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/alexcpn/e6bbdb900c9d3cab054590428e1b17fc.js"></script></figure><blockquote name="861f" id="861f" class="graf graf--blockquote graf-after--figure">create table demo_table( year int,month int,day int, bin tuple&lt;double,double&gt;, cell text, time_key tuple&lt;timestamp,timestamp&gt;,event text,<strong class="markup--strong markup--blockquote-strong"> PRIMARY KEY</strong>(<strong class="markup--strong markup--blockquote-strong">(bin,year,month,day),</strong>cell,time_key));</blockquote><h4 name="040b" id="040b" class="graf graf--h4 graf-after--blockquote">Test and measure your reads &amp; write via nodetool cfstats</h4><p name="f60b" id="f60b" class="graf graf--p graf-after--h4">How do we know if our data model is distributing writes across nodes? How do we know if the write latency and read latency is distributed across nodes and if it is linearly scale able in proportional to the nodes added? The answer to all of this via node tool cfstats command</p><div name="1eb6" id="1eb6" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://docs.datastax.com/en/cassandra/2.1/cassandra/tools/toolsCFstats.html" data-href="https://docs.datastax.com/en/cassandra/2.1/cassandra/tools/toolsCFstats.html" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://docs.datastax.com/en/cassandra/2.1/cassandra/tools/toolsCFstats.html"><strong class="markup--strong markup--mixtapeEmbed-strong">nodetool cfstats</strong><br><em class="markup--em markup--mixtapeEmbed-em">Provides statistics about tables.</em>docs.datastax.com</a><a href="https://docs.datastax.com/en/cassandra/2.1/cassandra/tools/toolsCFstats.html" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="5299efc1e608f7248929d94896908ea6"></a></div><p name="0c51" id="0c51" class="graf graf--p graf-after--mixtapeEmbed">You need to run long runs with write and then read operations using multiple nodes and everyday update a table like one below based on the output from cfstats. Soon you will know if your write and read are balanced. Actually adding more nodes should also decrease your read time linearly. This is really beautiful.</p><figure name="f30b" id="f30b" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/alexcpn/23f2caa1f6384e8808b0ee20122dd2b2.js"></script></figure><h4 name="73a0" id="73a0" class="graf graf--h4 graf-after--figure">Do not use ALLOW FILTERING and IN Clause in CQL indiscriminately</h4><p name="1258" id="1258" class="graf graf--p graf-after--h4">If you feel that there is no way out; then please read the section above. Most probably your table modelling has to be refactored.</p><blockquote name="3ad8" id="3ad8" class="graf graf--blockquote graf-after--p">When your query is rejected by Cassandra because it needs filtering, you should resist the urge to just add ALLOW FILTERING to it. You should think about your data, your model and what you are trying to do. -<a href="https://www.datastax.com/dev/blog/allow-filtering-explained-2" data-href="https://www.datastax.com/dev/blog/allow-filtering-explained-2" class="markup--anchor markup--blockquote-anchor" rel="nofollow noopener" target="_blank">https://www.datastax.com/dev/blog/allow-filtering-explained-2</a></blockquote><p name="820a" id="820a" class="graf graf--p graf-after--blockquote"><strong class="markup--strong markup--p-strong">Or for that matter IF clause — Light Weight Transactions</strong></p><p name="fba3" id="fba3" class="graf graf--p graf-after--p">The new versions of Cassandra support light-weight transactions. In CQL this is done via the IF clause. <em class="markup--em markup--p-em">Insert into table IF NOT EXISTS</em>.</p><blockquote name="8bee" id="8bee" class="graf graf--blockquote graf-after--p"><a href="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlLtwtTransactions.html" data-href="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlLtwtTransactions.html" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank">Lightweight transactions</a> should not be used casually, as the latency of operations increases fourfold due to the due to the round-trips necessary between the CAS coordinators. -<a href="https://docs.datastax.com/en/cql/3.3/cql/cql_using/useInsertLWT.html" data-href="https://docs.datastax.com/en/cql/3.3/cql/cql_using/useInsertLWT.html" class="markup--anchor markup--blockquote-anchor" rel="nofollow noopener" target="_blank">https://docs.datastax.com/en/cql/3.3/cql/cql_using/useInsertLWT.html</a></blockquote><p name="10bd" id="10bd" class="graf graf--p graf-after--blockquote">There is also a usage restriction of using LightWeight transactions (IF EXISTS, IF NOT EXISTS) in Cassandra.</p><p name="1725" id="1725" class="graf graf--p graf-after--p">If an INSERT/UPDATE/DELETE statement uses it then in that flow all such statements should use it; as the statements are ordered by the timestamps; and for LWT to execute the Paxos algorithm will take some time; which may cause statements without it to be executed/inserted with a timestamp earlier than the later statements in the code; Explained here better <br> <a href="https://jira.apache.org/jira/browse/CASSANDRA-14304" data-href="https://jira.apache.org/jira/browse/CASSANDRA-14304" class="markup--anchor markup--p-anchor" title="Follow link" rel="nofollow noopener" target="_blank">https://jira.apache.org/jira/browse/CASSANDRA-14304</a></p><blockquote name="0b51" id="0b51" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">If you want to maintain linearizable consistency you need to also issue the DELETE as a LWT. If you don’t there is no guarantee that the INSERT will come before the DELETE. I believe this is still the case when you have only 1 node, but regardless even if you didn’t have one node you’d still want to issue the DELETE with IF EXISTS in an actual cluster otherwise you’ll be even more prone to this problem.</em></blockquote><h4 name="1503" id="1503" class="graf graf--h4 graf-after--blockquote">Do not use Materialized Views — or use carefully</h4><p name="c2fb" id="c2fb" class="graf graf--p graf-after--h4">Materialized View was marked as experimental after they released it for production as there can be an inconsistency between the base table and view</p><p name="c998" id="c998" class="graf graf--p graf-after--p">[1] <a href="https://www.mail-archive.com/dev@cassandra.apache.org/msg11516.html" data-href="https://www.mail-archive.com/dev@cassandra.apache.org/msg11516.html" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://www.mail-archive.com/dev@cassandra.apache.org/msg11516.html</a>.</p><p name="5cb9" id="5cb9" class="graf graf--p graf-after--p">[2] <a href="https://docs.datastax.com/en/dse/6.0/cql/cql/cql_using/understandMV.html#understandMV__baseViewInconsistency" data-href="https://docs.datastax.com/en/dse/6.0/cql/cql/cql_using/understandMV.html#understandMV__baseViewInconsistency" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://docs.datastax.com/en/dse/6.0/cql/cql/cql_using/understandMV.html#understandMV__baseViewInconsistency</a></p><p name="22d9" id="22d9" class="graf graf--p graf-after--p"><a href="https://docs.datastax.com/en/dse/6.0/cql/cql/cql_using/bestPracticesMV.html" data-href="https://docs.datastax.com/en/dse/6.0/cql/cql/cql_using/bestPracticesMV.html" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://docs.datastax.com/en/dse/6.0/cql/cql/cql_using/bestPracticesMV.html</a> (not sure if this is updated)</p><p name="0b1f" id="0b1f" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">Write to base tables with materialized views using consistency levels greater than ONE</em></p><p name="acb5" id="acb5" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">Run repair on both the base table and the view whenever a node is removed, replaced, down //SOP</em></p><p name="e6c3" id="e6c3" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">We recommend against creating a materialized view with filtering on a non-primary key column</em></p><p name="3430" id="3430" class="graf graf--p graf-after--p"><a href="https://www.instaclustr.com/apache-cassandra-materialized-view-instaclustr-support/" data-href="https://www.instaclustr.com/apache-cassandra-materialized-view-instaclustr-support/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://www.instaclustr.com/apache-cassandra-materialized-view-instaclustr-support/</a> (has lot more details)</p><p name="3c64" id="3c64" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">Under normal conditions, data is quickly made available in the views. Use the </em><code class="markup--code markup--p-code"><em class="markup--em markup--p-em">ViewWriteMetrics</em></code><em class="markup--em markup--p-em"> metric to track the view propagation time.</em></p><p name="95a3" id="95a3" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">We recommend that you explicitly test the correctness of materialized views for your application scenarios, including under load (do not assume correctness).</em></p><h4 name="984b" id="984b" class="graf graf--h4 graf-after--p">Be aware of the JVM GC Suck-age as JVM Heap Increases</h4><p name="e711" id="e711" class="graf graf--p graf-after--h4">Cassandra runs on the JVM and relies on the OS page cache for improving performance. <em class="markup--em markup--p-em">There is no need to throw huge amounts of RAM at Cassandra</em>. Cassandra performance should increase by adding more low powered nodes.We have run our long runs for about 2 weeks with load on 2 GB JVM heap, and Cassandra had never once gone down.</p><p name="df9c" id="df9c" class="graf graf--p graf-after--p">JVM GC suckage is directly proportional to the JVM heap. This is true for any Java process and also for Cassandra</p><figure name="be45" id="be45" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 533px; max-height: 400px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 75%;"></div><img class="graf-image" data-image-id="1*HQhjWbOdml9VTeSYo18Pdw.png" data-width="533" data-height="400" src="https://cdn-images-1.medium.com/max/800/1*HQhjWbOdml9VTeSYo18Pdw.png"></div><figcaption class="imageCaption">source-<a href="https://www.slideshare.net/mattdennis/cassandra-antipatterns" data-href="https://www.slideshare.net/mattdennis/cassandra-antipatterns" class="markup--anchor markup--figure-anchor" rel="nofollow noopener noopener" target="_blank">https://www.slideshare.net/mattdennis/cassandra-antipatterns</a></figcaption></figure><p name="da9f" id="da9f" class="graf graf--p graf-after--figure"><em class="markup--em markup--p-em">Some illuminating quotes</em></p><p name="3659" id="3659" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">Many users new to Cassandra are tempted to turn up Java heap size too high, which consumes the majority of the underlying system’s RAM. In most cases, increasing the Java heap size is actually </em><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">detrimental</em></strong><em class="markup--em markup--p-em"> for these reasons:</em></p><p name="3569" id="3569" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">1</em>. <em class="markup--em markup--p-em">In most cases, the capability of Java to gracefully handle garbage collection above 8GB quickly diminishes.</em></strong></p><p name="0c46" id="0c46" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">2. Modern operating systems maintain the OS page cache for frequently accessed data and are very good at keeping this data in memory, but can be prevented from doing its job by an elevated Java heap size.</em></p><p name="f7a1" id="f7a1" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">If you have more than 2GB of system memory, which is typical, keep the size of the Java heap relatively small to allow more memory for the page cache .</em></p><div name="8a76" id="8a76" class="graf graf--mixtapeEmbed graf-after--p"><a href="http://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_tune_jvm_c.html" data-href="http://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_tune_jvm_c.html" class="markup--anchor markup--mixtapeEmbed-anchor" title="http://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_tune_jvm_c.html"><strong class="markup--strong markup--mixtapeEmbed-strong">Tuning Java resources</strong><br><em class="markup--em markup--mixtapeEmbed-em">Consider tuning Java resources in the event of a performance degradation or high memory consumption.</em>docs.datastax.com</a><a href="http://docs.datastax.com/en/cassandra/2.0/cassandra/operations/ops_tune_jvm_c.html" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="098c8e47b45b567095d35d2d4b48514a"></a></div><p name="4efa" id="4efa" class="graf graf--p graf-after--mixtapeEmbed">A database like <a href="http://www.scylladb.com/open-source/" data-href="http://www.scylladb.com/open-source/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Scylla DB</a> has ported the Cassandra design on to C++ so as to avoid the GC pauses and other such problems related to JVM. But as long as you keep the JVM heap around 8 GB things should be fine.</p><p name="e23d" id="e23d" class="graf graf--p graf-after--p">An update here- While I was working with Cassandra G1GC was not deemed stable enough to be used. Now DataStax version of Cassandra used G1GC. G1GC can handle larger heaps; however, Cassandra can use RAM heavily for page caches, filters etc, so all the above still makes sense. Limit JVM heap to the minimum you need and leave the rest of the memory for Cassandra process.</p><h4 name="a0f6" id="a0f6" class="graf graf--h4 graf-after--p">Cassandra does not like SAN/Shared Storage</h4><p name="c898" id="c898" class="graf graf--p graf-after--h4">Cassandra is designed for the low fetch times of spinning disks by only appending data to the end for writes and minimize disk seek time during read via application selected partition keys and thereby spreading reads across multiple nodes — Regarding storage a good slide to go through <a href="https://www.slideshare.net/johnny15676/why-does-my-choiceofstorage-matterwithcassandra" data-href="https://www.slideshare.net/johnny15676/why-does-my-choiceofstorage-matterwithcassandra" class="markup--anchor markup--p-anchor" title="https://www.slideshare.net/johnny15676/why-does-my-choiceofstorage-matterwithcassandra" rel="noreferrer noopener noopener noopener" target="_blank">https://www.slideshare.net/johnny15676/why-does-my-choiceofstorage-matterwithcassandra</a></p><figure name="9e1c" id="9e1c" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 613px; max-height: 449px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 73.2%;"></div><img class="graf-image" data-image-id="1*SEX2I_8ohef5sG65VuX5ow.png" data-width="613" data-height="449" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*SEX2I_8ohef5sG65VuX5ow.png"></div><figcaption class="imageCaption">source-<a href="https://www.slideshare.net/johnny15676/why-does-my-choiceofstorage-matterwithcassandra" data-href="https://www.slideshare.net/johnny15676/why-does-my-choiceofstorage-matterwithcassandra" class="markup--anchor markup--figure-anchor" title="https://www.slideshare.net/johnny15676/why-does-my-choiceofstorage-matterwithcassandra" rel="noreferrer noopener noopener noopener noopener noopener" target="_blank">https://www.slideshare.net/johnny15676/why-does-my-choiceofstorage-matterwithcassandra</a></figcaption></figure><blockquote name="5b27" id="5b27" class="graf graf--blockquote graf-after--figure">Customer/User — “We have an awesome SAN and would like to use it for Cassandra.”<br>DataStax — “We don’t recommend shared storage for Cassandra.”<br>Customer/User — “Why not.”<br>DataStax — “Two reasons really. One — performance suffers. Two — shared storage introduces a single point of failure into the architecture.”<br>Customer/User — “Our SAN is awesome and has never had any down time and can preform a kagillion IOPS. So why exactly shouldn’t we use shared storage.”</blockquote><blockquote name="8db5" id="8db5" class="graf graf--blockquote graf-after--blockquote"><a href="https://www.datastax.com/dev/blog/impact-of-shared-storage-on-apache-cassandra" data-href="https://www.datastax.com/dev/blog/impact-of-shared-storage-on-apache-cassandra" class="markup--anchor markup--blockquote-anchor" rel="nofollow noopener noopener" target="_blank">https://www.datastax.com/dev/blog/impact-of-shared-storage-on-apache-cassandra</a></blockquote><h4 name="2539" id="2539" class="graf graf--h4 graf-after--blockquote">Horizontal Scale-ability -Transparent Sharding vs Application Level Sharding</h4><p name="f4c4" id="f4c4" class="graf graf--p graf-after--h4">Database sharding is a way of horizontally scaling database. Application level sharding means that the logic of partitioning data across multiple nodes is done at the application level. That is based on some key- classic example — East Coast vs West Coast or <a href="http://www.malinga.me/application-aware-sharding-for-a-mysql-database/" data-href="http://www.malinga.me/application-aware-sharding-for-a-mysql-database/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">similar</a>; your DB write code will select a Database to connect, write and read. The problem is that the complexity of application-level sharding quickly gets complex and it is not a good way to scale. Cassandra and most NoSQL databases do sharding transparently (as you have seen via the partition key). This is a pretty big advantage, as without this horizontal scaling is a hard problem.</p><h4 name="db8e" id="db8e" class="graf graf--h4 graf-after--p">Open-Source and Commercial</h4><p name="a666" id="a666" class="graf graf--p graf-after--h4 graf--trailing">As of the time of writing this, relations between Apache Foundation and Datastax- which was one of the largest contributors to Cassandra ? have soured. There is a commercial version of Cassandra — Datastax Enterprise Edition and open source version is the Apache Cassandra. The Java driver of Cassandra has two versions, the open source and DSE provided, and you cannot use a commercial driver with open source Cassandra. For other languages like Go the driver is open source.</p></div></div></section><section name="facb" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="d2bb" id="d2bb" class="graf graf--p graf--leading">You may also find the following post of value</p><div name="ce62" id="ce62" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://medium.com/techlogs/apache-cassandra-the-minimum-internals-you-need-to-know-89724603abb2" data-href="https://medium.com/techlogs/apache-cassandra-the-minimum-internals-you-need-to-know-89724603abb2" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://medium.com/techlogs/apache-cassandra-the-minimum-internals-you-need-to-know-89724603abb2"><strong class="markup--strong markup--mixtapeEmbed-strong">Apache Cassandra — The minimum internals you need to know</strong><br><em class="markup--em markup--mixtapeEmbed-em">For effective data modeling and comparison with other DB’s</em>medium.com</a><a href="https://medium.com/techlogs/apache-cassandra-the-minimum-internals-you-need-to-know-89724603abb2" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="5346b3780e4ffafe2e3f2229e9722d0b" data-thumbnail-img-id="1*RyzNZXf_b6WA04DOqeLVoA.png" style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/1*RyzNZXf_b6WA04DOqeLVoA.png);"></a></div><p name="8235" id="8235" class="graf graf--p graf-after--mixtapeEmbed graf--trailing">For running in virtualized environment, there are many gotchas , virtual network interface, virtual disks, ceph (anit-pattern) etc. This blog post goes deep though I have not had the experience with VMs <a href="https://tobert.github.io/pages/als-cassandra-21-tuning-guide.html" data-href="https://tobert.github.io/pages/als-cassandra-21-tuning-guide.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://tobert.github.io/pages/als-cassandra-21-tuning-guide.html</a></p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@alexcpn" class="p-author h-card">Alex Punnen</a> on <a href="https://medium.com/p/ac599926e4b8"><time class="dt-published" datetime="2018-02-12T17:06:39.121Z">February 12, 2018</time></a>.</p><p><a href="https://medium.com/@alexcpn/using-apache-cassandra-a-few-things-before-you-start-ac599926e4b8" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on August 22, 2019.</p></footer></article></body></html>